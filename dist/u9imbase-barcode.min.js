/*! 
 * 
 * Copyright 2017 u9mobile. 
 * 
 * u9imbase-barcode, v1.0.0 
 * 智能工厂移动应用-Base_Barcode库 
 * 
 * By @lwd 
 * 
 * Licensed under the MIT license. Please see LICENSE for more information. 
 * 
 */

!function(e,r){function t(){this.context=a()}function o(e){e.type="POST",n(e)}function n(r){var t={type:"GET",dataType:"JSON",cache:!0,xhrFields:{withCredentials:!0},urlPata:{},formPata:{},error:function(e){},success:function(e){}};if(void 0===r.dataType&&(r.dataType=t.dataType),void 0===r.type?r.type="GET":(r.dataType,r.type="POST",r.data=r.type),void 0===r.cache&&(r.cache=t.cache),void 0!==r.urlPata){var o="",n=r.urlPata;for(var a in n)o+="&"+a+"="+n[a];r.url.indexOf("?")>=0?r.url+=o:r.url+=o.replace("&","?")}e.ajax({type:r.type,dataType:r.dataType,cache:r.cache,xhrFields:{withCredentials:!0},url:r.url,data:r.data,timeout:18e5,error:function(e){"function"==typeof r.error&&r.error(e)},success:function(e){r.success(e)}})}function a(){var e={},t=JSON.parse(window.localStorage.getItem("U9ImPDA_org")),o="";t&&(o=t.Code),!o&&r.User("Orgs")&&(o=r.User("Orgs")[0].Code,t||window.localStorage.setItem("U9ImPDA_org",JSON.stringify(r.User("Orgs")[0]))),o&&(e.orgCode=o);var n=r.User("Orgs")[0].ErpEntCode;n&&(e.entCode=n);var a=r.User("Orgs")[0].ErpUserCode;return a?e.userCode=a:"智能工厂未定义用户的ERP用户编码，PDA读取ERP用户编码失败！",e.sysMLFlag="zh-CN",e}function i(e){var t=r.Connect("address"),o=r.Connect("port");return t&&o?"http://"+t+":"+o+e:null}function s(e){for(var r="",t=0;t<e;t++)r+="0";return r}t.prototype.getOrgCode=function(){var e=JSON.Parse(window.localStorage.getItem("U9ImPDA_org")),t="";return e&&(t=e.Code),!t&&r.User("Orgs")&&(t=r.User("Orgs")[0].Code,e||window.localStorage.setItem("U9ImPDA_org",JSON.stringify(r.User("Orgs")[0]))),t},t.prototype.barCodeAnalyze=function(e,r,t){var n={};n.url=i("/api/barcodeinfo/getBarCodeInfo"),n.data={Parameter:{BarCode:e.BarCode,OpType:e.OpType,DocTypeEnum:e.DocTypeEnum,EntCode:this.context.entCode,OrgCode:this.context.orgCode,UserCode:this.context.userCode,CultureName:this.context.sysMLFlag,OperationKey:e.OperationKey}},n.success=function(e){r&&r(e)},n.errorFn=function(e){t&&t(e)},o(n)},t.prototype.barCodeAnalyzeOnlyItemBC=function(e,r,t){var n={};n.url=i("/api/barcodeinfo/getBarCodeInfo"),n.data={Parameter:{BarCode:e,OpType:"BC_P_BarCodeAnalyze_Item_PDA",DocTypeEnum:-1,EntCode:this.context.entCode,OrgCode:this.context.orgCode,UserCode:this.context.userCode,CultureName:this.context.sysMLFlag,OperationKey:"QuickTransIn_BarCodeAnalyze"}},n.success=function(e){r&&r(e)},n.errorFn=function(e){t&&t(e)},o(n)},t.prototype.createDoc=function(e,t,n){var a=new Date,s={};s.url=i("/api/barcodeinfo/CreateRcvRecord"),s.data={Parameter:{OpType:e.OpType,DocType:e.DocTypeEnum,CultureName:this.context.sysMLFlag,EntCode:this.context.entCode,OrgCode:this.context.orgCode,UserCode:this.context.userCode,RcvUser:r.User("_id"),CreatedBy:this.context.userCode,RcvDateTime:a,CreateDocJSON:e.CreateDocJSON,DocDetialList:e.DocDetailList,OperationKey:e.OperationKey,IfWhTrans:e.IfWhTrans,AppKey:e.AppKey,DocCode:e.DocCode,OperType:e.OperType,SourceDocNum:e.SourceDocNum,BizOrgName:e.BizOrgName,Direction:e.Direction}},s.success=function(e){t&&t(e)},s.errorFn=function(e){n&&n(e)},o(s)},t.prototype.getWarehouseList=function(e,r,t){var n={};n.url=i("/api/barcodeInfo/getWarehouseList"),n.data={Parameter:{orgCode:e}},n.success=function(e){r&&r(e)},n.errorFn=function(e){t&&t(e)},o(n)},t.prototype.getBinList=function(e,r,t,n){var a={};a.url=i("/api/barcodeInfo/getBinList"),a.data={Parameter:{orgCode:e,wh:r}},a.success=function(e){t&&t(e)},a.errorFn=function(e){n&&n(e)},o(a)},t.prototype.fnRoundValue=function(e,r,t,o){if(!e)return"0";var n="";if(-1===String(e).indexOf("."))return 0===r?e:n=e+"."+s(r);if(e.substring(e.indexOf(".")+1).length<Number(r)){for(var a=Number(r)-e.substring(e.indexOf(".")+1).length,i="0",c=1;c<a;c++)i+="0";return e+=i}var u=e.indexOf(".")+Number(r),d=e.substring(0,Number(u)+1),p=e.substring(Number(u)+1,Number(u)+2),g=e.substring(Number(u)+1,e.length);if(0===Number(t)){var l="1"+Number(g),f="1"+s(e.length-1-u);if(accSub(l,f)>0){var y="";y=0===Number(r)?"1":"0."+s(r-1)+"1",n=accAdd(d,y)}else n=0===r?e.substring(0,u):e.substring(0,u+1)}else if(1===Number(t))n=e.substring(0,u+1);else if(2===Number(t))if(Number(p)<o)n=e.substring(0,u+1);else{var C="0";C=0===Number(r)?"1":"0."+s(r-1)+"1",n=Number(e)>0?accAdd(d,C):accSub(d,C)}return n},t.prototype.accAdd=function(e,r){var t,o=0,n=0,a=String(e).split(".");a&&a.length>0&&a[1]&&(o=a[1].length);var i=String(r).split(".");return i&&i.length>0&&i[1]&&(n=i[1].length),t=Math.pow(10,Math.max(o,n)),(e*t+r*t)/t},t.prototype.accSub=function(e,r){var t,o,n=0,a=0,i=String(e).split(".");i&&i.length>0&&i[1]&&(n=i[1].length);var s=String(r).split(".");return s&&s.length>0&&s[1]&&(a=s[1].length),t=Math.pow(10,Math.max(n,a)),o=n>=a?n:a,((e*t-r*t)/t).toFixed(o)},window.BarCodeServices=new t}(jquery,window.u9);